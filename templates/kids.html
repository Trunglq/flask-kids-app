<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Helper for Kids</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-image: url("{{ url_for('static', filename='background.jpg') }}");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            margin: 0;
            color: #333;
        }
        .main-container {
            display: flex;
            gap: 20px;
            width: 90%;
            max-width: 1200px;
            margin: 20px auto;
            flex: 1;
        }
        .chat-column {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            flex: 60%;
            max-height: 600px;
            overflow-y: auto;
        }
        .popular-column, .recent-column {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            flex: 20%;
            max-height: 600px;
            overflow-y: auto;
        }
        h2 {
            font-size: 24px;
            color: #1E88E5;
            margin-bottom: 20px;
            text-align: left;
        }
        h3 {
            font-size: 20px;
            color: #4CAF50;
            margin-bottom: 15px;
        }
        p {
            font-size: 18px;
            margin: 10px 0;
        }
        .problem-statement {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: bold;
            color: #1E88E5;
            border-left: 4px solid #1E88E5;
        }
        .hint-text {
            font-size: 18px;
            margin: 10px 0;
        }
        .content-section {
            margin-top: 30px;
        }
        form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .input-section {
            width: 100%;
            max-width: 700px;
            margin: 0 auto 20px auto;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        }
        .input-container {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            width: 100%;
        }
        textarea {
            padding: 10px;
            font-size: 16px;
            border: 2px solid #1E88E5;
            border-radius: 5px;
            width: 100%;
            box-sizing: border-box;
            resize: vertical;
            min-height: 40px;
            max-height: 150px;
            overflow-y: auto;
            font-family: Arial, sans-serif;
        }
        .ask-btn, .upload-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        .ask-btn:hover, .upload-btn:hover {
            background-color: #45a049;
        }
        .upload-btn {
            background-color: #FF9800;
        }
        .upload-btn:hover {
            background-color: #e68900;
        }
        .file-input {
            display: none;
        }
        .file-link {
            color: #1E88E5;
            text-decoration: none;
            font-size: 16px;
            margin: 10px 0;
            display: inline-block;
        }
        .file-link:hover {
            text-decoration: underline;
        }
        .attachment-area {
            margin-top: 20px;
            padding: 10px;
            border-top: 1px solid #ddd;
            text-align: center;
        }
        .button-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .full-width-btn {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .explain-more-btn {
            background-color: #FF9800;
        }
        .explain-more-btn:hover {
            background-color: #e68900;
        }
        .got-it-btn {
            background-color: #1E88E5;
        }
        .got-it-btn:hover {
            background-color: #1565C0;
        }
        .tip-link, .usage-link {
            display: block;
            margin-top: 15px;
            color: #9C27B0;
            text-decoration: none;
            font-size: 16px;
            cursor: pointer;
        }
        .tip-link:hover, .usage-link:hover {
            text-decoration: underline;
        }
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
        }
        .loading-bar {
            width: 100%;
            max-width: 300px;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        .loading-bar::before {
            content: '😊';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 30px;
            background-color: #FFEB3B;
            border-radius: 10px;
            animation: move 2s infinite linear;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        @keyframes move {
            0% { left: -30px; }
            100% { left: 100%; }
        }
        .loading-text {
            font-style: italic;
            color: #FF5722;
            font-size: 16px;
        }
        .problem-list, .recent-problems {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .problem-item, .recent-item {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 16px;
            text-align: left;
        }
        .problem-item:hover, .recent-item:hover {
            background-color: #e0e0e0;
        }
        .problem-list-container {
            font-style: italic;
            color: #666;
            margin: 10px 0;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            position: relative;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
        .modal-content h4 {
            margin: 0 0 15px;
            font-size: 20px;
            color: #4CAF50;
        }
        .modal-content p {
            font-size: 16px;
            margin: 0 0 20px;
        }
        .close-btn {
            background-color: #FF5722;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .close-btn:hover {
            background-color: #e64a19;
        }
        .geometry-image {
            max-width: 100%;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .top-bar {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 10px;
            background-color: #f0f0f0;
            border-bottom: 1px solid #ddd;
            width: 100%;
            max-width: 700px;
            margin: 0 auto 0 auto;
        }
        .subject-select-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .subject-label {
            font-size: 16px;
            margin: 0;
        }
        
        /* Mobile view: hide side columns, pin input to bottom */
        @media only screen and (max-width: 768px) {
            .popular-column,
            .recent-column {
                display: none !important;
            }
            .main-container {
                flex-direction: column;
            }
            .input-section {
                position: fixed !important;
                bottom: 0;
                left: 50%;
                transform: translateX(-50%);
                width: 100% !important;
                max-width: none;
                margin: 0;
                border-radius: 0;
                box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
                z-index: 1000;
            }
            .chat-column {
                max-height: calc(100vh - 120px) !important;
                padding-bottom: 130px;
            }
            body {
                padding-bottom: 130px;
            }
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="subject-select-group">
            <label for="subject-select" class="subject-label">Môn học:</label>
            <form method="POST" id="subject-form" style="display:inline;">
                <input type="hidden" name="action" value="change_subject">
                <select name="subject" id="subject-select" onchange="onSubjectChange()">
                    <option value="math" {% if session.get('subject', 'math') == 'math' %}selected{% endif %}>Toán</option>
                    <option value="vietnamese" {% if session.get('subject', 'math') == 'vietnamese' %}selected{% endif %}>Tiếng Việt (Văn)</option>
                </select>
            </form>
        </div>
    </div>
    <div id="app-config" 
         data-loading="{{ 'true' if loading else 'false' }}" 
         data-hint="{{ hint }}"
         data-loading-message="{{ loading_message if loading_message else '' }}">
    </div>
    <div class="main-container">
        <!-- Cột chính (chat box, 60%) -->
        <div class="chat-column">
            <h2>Chào bạn! 👋</h2>
            <div class="content-section">
                {% if current_question %}
                    <div class="problem-statement">
                        Đề bài: {{ current_question | safe }}
                    </div>
                {% endif %}
                {% if image_path %}
                    <img src="{{ url_for('serve_tmp_file', filename=image_path.split('tmp/')[1]) }}" alt="Hình minh họa" class="geometry-image">
                {% endif %}
                {% if loading %}
                    <div class="loading-container">
                        <div class="loading-bar"></div>
                        <p class="loading-text">{{ loading_message }}</p>
                    </div>
                {% else %}
                    {% if hint.startswith('Tớ không') or hint.startswith('Hãy chọn') or hint.startswith('Bạn chưa') or hint.startswith('Có lỗi') or hint.startswith('Bạn giỏi') or hint.startswith('Lịch sử') or hint.startswith('Ảnh đã') or hint.startswith('File không') or hint.startswith('Nhập bài toán') or hint.startswith('File đã') or hint.startswith('Tớ thấy các bài toán') %}
                        {% if hint.startswith('Tớ thấy các bài toán') %}
                            <p class="hint-text">
                                Tớ thấy các bài toán: 
                                {% set problems_list = hint.split(': ')[1].split('. ')[0].split(', ') %}
                                {% for problem in problems_list %}
                                    <span class="problem-link" onclick="selectProblemFromList('{{ problem.strip() }}')" style="color: #1E88E5; text-decoration: underline; cursor: pointer;">{{ problem.strip() }}{% if not loop.last %}, {% endif %}</span>
                                {% endfor %}
                                . Bạn muốn hỏi về bài nào?
                            </p>
                        {% else %}
                            <p class="hint-text">{{ hint }}</p>
                        {% endif %}
                        
                        {% if extraction_status == 'ready' %}
                        <!-- Extraction is now handled automatically -->
                        {% endif %}
                    {% else %}
                        {% if hint.startswith('Tớ thấy các bài toán') %}
                            <p class="hint-text">
                                Tớ thấy các bài toán: 
                                {% set problems_list = hint.split(': ')[1].split('. ')[0].split(', ') %}
                                {% for problem in problems_list %}
                                    <span class="problem-link" onclick="selectProblemFromList('{{ problem.strip() }}')" style="color: #1E88E5; text-decoration: underline; cursor: pointer;">{{ problem.strip() }}{% if not loop.last %}, {% endif %}</span>
                                {% endfor %}
                                . Bạn muốn hỏi về bài nào?
                            </p>
                        {% else %}
                            {% if hint == "Nhập bài toán, bài tập Tiếng Việt hoặc tải ảnh đề bài để nhận gợi ý nhé! Đừng ngại hỏi bất cứ điều gì, tớ luôn sẵn sàng giúp bạn! 😊" %}
                            <p class="hint-text">
                              <b>Hướng dẫn:</b> Bạn hãy nhập một bài toán Toán hoặc một bài tập Tiếng Việt/Văn vào ô bên dưới, hoặc tải lên ảnh chụp đề bài để nhận gợi ý từng bước phù hợp với lứa tuổi.<br>
                              <span style="color:#4CAF50;">
                                Bạn có thể hỏi về phép tính, bài toán có lời văn, hoặc bài tập đọc hiểu, luyện từ và câu, tập làm văn... Nếu tải ảnh, hệ thống sẽ tự động trích xuất và gợi ý cho bạn.
                              </span>
                            </p>
                            {% else %}
                            <p class="hint-text">{% if current_step > 0 %}Gợi ý {{ current_step + 1 }}: {% endif %}{{ hint }}</p>
                            {% endif %}
                        {% endif %}
                    {% endif %}
                {% endif %}
                <!-- Khu vực danh sách bài toán -->
                {% if extracted_problems and not hint.startswith('Tớ thấy các bài toán') %}
                    <div class="problem-list-container">
                        {% set problems_text = extracted_problems %}
                        {% set problems_list = problems_text.split(': ')[1].split('. ')[0].split(', ') %}
                        Tớ thấy các bài toán: 
                        {% for problem in problems_list %}
                            <span class="problem-link" onclick="selectProblemFromList('{{ problem.strip() }}')" style="color: #1E88E5; text-decoration: underline; cursor: pointer;">{{ problem.strip() }}{% if not loop.last %}, {% endif %}</span>
                        {% endfor %}
                        . Bạn muốn hỏi về bài nào?
                    </div>
                {% endif %}
            </div>
            {% if hint != "Nhập bài toán, bài tập Tiếng Việt hoặc tải ảnh đề bài để nhận gợi ý nhé! Đừng ngại hỏi bất cứ điều gì, tớ luôn sẵn sàng giúp bạn! 😊" and hint != "File đã được tải lên thành công. Đang tự động trích xuất nội dung..." and not loading %}
                <form method="POST" id="action-form">
                    <div class="button-container">
                        <button type="submit" name="action" value="explain_more" class="full-width-btn explain-more-btn">
                            <span>📖</span> Giải thích thêm
                        </button>
                        <button type="submit" name="action" value="got_it" class="full-width-btn got-it-btn">
                            <span>😊</span> Tớ hiểu rồi!
                        </button>
                    </div>
                    <a class="tip-link" onclick="showParentTip()">Mẹo cho cha mẹ</a>
                    <a href="/api_usage" class="usage-link">Xem chi phí token</a>
                </form>
            {% endif %}
            <!-- Khu vực file đính kèm -->
            {% if attached_file %}
                <div class="attachment-area">
                    <a href="{{ url_for('serve_tmp_file', filename=attached_file.split('/')[-1]) }}" target="_blank" class="file-link">
                        Xem file đính kèm: {{ attached_file.split('\\')[-1] if '\\' in attached_file else attached_file.split('/')[-1] }}
                    </a>
                </div>
            {% endif %}
        </div>

        <!-- Cột danh sách bài toán phổ biến (20%) -->
        <div class="popular-column">
            <h3>
                {% if session.get('subject', 'math') == 'math' %}
                    Những bài toán phổ biến lớp {{ session.get('grade', '4') }} 📚
                {% else %}
                    Những bài Tiếng Việt/Văn phổ biến lớp {{ session.get('grade', '4') }} 📖
                {% endif %}
            </h3>
            <div class="problem-list">
                {% if session.get('subject', 'math') == 'math' %}
                    {% if session.get('grade', '4') == '1' %}
                        <!-- Bài toán lớp 1 -->
                        <div class="problem-item" onclick="selectProblem('Tính: 5 + 3')">Tính: 5 + 3</div>
                        <div class="problem-item" onclick="selectProblem('Tính: 9 - 4')">Tính: 9 - 4</div>
                        <div class="problem-item" onclick="selectProblem('Lan có 6 quả táo, mẹ cho thêm 2 quả. Hỏi Lan có bao nhiêu quả táo?')">Lan có 6 quả táo, mẹ cho thêm 2 quả. Hỏi Lan có bao nhiêu quả táo?</div>
                        <div class="problem-item" onclick="selectProblem('An có 7 cái kẹo, An cho bạn Mai 3 cái. Hỏi An còn lại bao nhiêu cái kẹo?')">An có 7 cái kẹo, An cho bạn Mai 3 cái. Hỏi An còn lại bao nhiêu cái kẹo?</div>
                        <div class="problem-item" onclick="selectProblem('Vẽ 1 hình tam giác, 1 hình tròn và 1 hình vuông')">Vẽ 1 hình tam giác, 1 hình tròn và 1 hình vuông</div>
                    {% elif session.get('grade', '4') == '2' %}
                        <!-- Bài toán lớp 2 -->
                        <div class="problem-item" onclick="selectProblem('Thực hiện phép tính: 52 + 18 - 33')">Thực hiện phép tính: 52 + 18 - 33</div>
                        <div class="problem-item" onclick="selectProblem('Điền số thích hợp vào chỗ chấm: 9 + … - … = 15')">Điền số thích hợp vào chỗ chấm: 9 + … - … = 15</div>
                        <div class="problem-item" onclick="selectProblem('Tìm x biết: x - 29 = 12')">Tìm x biết: x - 29 = 12</div>
                        <div class="problem-item" onclick="selectProblem('Tìm số lớn nhất có hai chữ số mà tổng hai chữ số bằng 15')">Tìm số lớn nhất có hai chữ số mà tổng hai chữ số bằng 15</div>
                        <div class="problem-item" onclick="selectProblem('Đặt tính rồi tính: 72 - 29')">Đặt tính rồi tính: 72 - 29</div>
                    {% elif session.get('grade', '4') == '3' %}
                        <!-- Bài toán lớp 3 -->
                        <div class="problem-item" onclick="selectProblem('Tính: 245 + 378')">Tính: 245 + 378</div>
                        <div class="problem-item" onclick="selectProblem('Tính: 486 ÷ 2')">Tính: 486 ÷ 2</div>
                        <div class="problem-item" onclick="selectProblem('Tính chu vi hình tam giác có 3 cạnh lần lượt là 5 cm, 7 cm và 8 cm.')">Tính chu vi hình tam giác có 3 cạnh lần lượt là 5 cm, 7 cm và 8 cm.</div>
                        <div class="problem-item" onclick="selectProblem('Một cửa hàng có 120 quả táo, bán được 45 quả. Hỏi còn lại bao nhiêu quả?')">Một cửa hàng có 120 quả táo, bán được 45 quả. Hỏi còn lại bao nhiêu quả?</div>
                        <div class="problem-item" onclick="selectProblem('Thực hiện phép tính: 7 × 8')">Thực hiện phép tính: 7 × 8</div>
                    {% elif session.get('grade', '4') == '4' %}
                        <!-- Bài toán lớp 4 -->
                        <div class="problem-item" onclick="selectProblem('Tính diện tích hình chữ nhật có chiều dài 10 cm và chiều rộng 6 cm.')">Tính diện tích hình chữ nhật có chiều dài 10 cm và chiều rộng 6 cm.</div>
                        <div class="problem-item" onclick="selectProblem('Cộng hai phân số 3/7 và 2/7.')">Cộng hai phân số 3/7 và 2/7.</div>
                        <div class="problem-item" onclick="selectProblem('Chia 24 viên kẹo cho hai bạn An và Bình theo tỉ số 3:5. Hỏi mỗi bạn được bao nhiêu viên kẹo?')">Chia 24 viên kẹo cho hai bạn An và Bình theo tỉ số 3:5. Hỏi mỗi bạn được bao nhiêu viên kẹo?</div>
                        <div class="problem-item" onclick="selectProblem('Một ô tô đi với vận tốc 60 km/giờ trong 1,5 giờ. Hỏi ô tô đi được bao nhiêu km?')">Một ô tô đi với vận tốc 60 km/giờ trong 1,5 giờ. Hỏi ô tô đi được bao nhiêu km?</div>
                        <div class="problem-item" onclick="selectProblem('Lan có 40 quả táo, chia cho Minh và Hoa theo tỉ số 3:2. Hỏi mỗi bạn được bao nhiêu quả táo?')">Lan có 40 quả táo, chia cho Minh và Hoa theo tỉ số 3:2. Hỏi mỗi bạn được bao nhiêu quả táo?</div>
                    {% elif session.get('grade', '4') == '5' %}
                        <!-- Bài toán lớp 5 -->
                        <div class="problem-item" onclick="selectProblem('Tính diện tích hình thang có đáy lớn 12 cm, đáy bé 8 cm, chiều cao 5 cm.')">Tính diện tích hình thang có đáy lớn 12 cm, đáy bé 8 cm, chiều cao 5 cm.</div>
                        <div class="problem-item" onclick="selectProblem('Một bể nước có thể tích 120 lít, đã lấy ra 35 lít nước. Hỏi còn lại bao nhiêu lít nước?')">Một bể nước có thể tích 120 lít, đã lấy ra 35 lít nước. Hỏi còn lại bao nhiêu lít nước?</div>
                        <div class="problem-item" onclick="selectProblem('Tìm x biết: x × 7 = 56')">Tìm x biết: x × 7 = 56</div>
                        <div class="problem-item" onclick="selectProblem('Một cửa hàng bán 15 kg gạo với giá 12.000 đồng/kg. Hỏi tổng số tiền bán được?')">Một cửa hàng bán 15 kg gạo với giá 12.000 đồng/kg. Hỏi tổng số tiền bán được?</div>
                        <div class="problem-item" onclick="selectProblem('Một hình chữ nhật có chu vi 36 cm, chiều dài hơn chiều rộng 4 cm. Tính diện tích hình chữ nhật đó.')">Một hình chữ nhật có chu vi 36 cm, chiều dài hơn chiều rộng 4 cm. Tính diện tích hình chữ nhật đó.</div>
                    {% elif session.get('grade', '4') == '6' %}
                        <!-- Bài toán lớp 6 -->
                        <div class="problem-item" onclick="selectProblem('Tính giá trị biểu thức: -15 + 7')">Tính giá trị biểu thức: -15 + 7</div>
                        <div class="problem-item" onclick="selectProblem('Giải phương trình: 2x + 3 = 11')">Giải phương trình: 2x + 3 = 11</div>
                        <div class="problem-item" onclick="selectProblem('Tính diện tích hình tam giác có đáy 8 cm và chiều cao 5 cm.')">Tính diện tích hình tam giác có đáy 8 cm và chiều cao 5 cm.</div>
                        <div class="problem-item" onclick="selectProblem('Viết dưới dạng số thập phân: 3/4')">Viết dưới dạng số thập phân: 3/4</div>
                        <div class="problem-item" onclick="selectProblem('Bảng sau ghi điểm toán của 40 học sinh: Điểm 5: 4 học sinh, điểm 6: 8 học sinh, điểm 7: 10 học sinh, điểm 8: 12 học sinh, điểm 9: 6 học sinh. Tính điểm trung bình của 40 học sinh.')">Tính điểm trung bình của 40 học sinh trong bảng điểm toán</div>
                    {% elif session.get('grade', '4') == '7' %}
                        <!-- Bài toán lớp 7 -->
                        <div class="problem-item" onclick="selectProblem('Tính giá trị biểu thức: 3/4 + 5/6 - 1/3.')">Tính giá trị biểu thức: 3/4 + 5/6 - 1/3.</div>
                        <div class="problem-item" onclick="selectProblem('Tìm x trong tỉ lệ thức: 2/3 = x/9.')">Tìm x trong tỉ lệ thức: 2/3 = x/9.</div>
                        <div class="problem-item" onclick="selectProblem('Rút gọn: (2x^2 - 3x + 5) + (x^2 + 4x - 1).')">Rút gọn: (2x^2 - 3x + 5) + (x^2 + 4x - 1).</div>
                        <div class="problem-item" onclick="selectProblem('Cho tam giác ABC có góc A = 50°, góc B = 60°. Tính góc C.')">Cho tam giác ABC có góc A = 50°, góc B = 60°. Tính góc C.</div>
                        <div class="problem-item" onclick="selectProblem('Tính thể tích hình lăng trụ đứng tam giác có diện tích đáy 12 cm^2 và chiều cao 5 cm.')">Tính thể tích hình lăng trụ đứng tam giác có diện tích đáy 12 cm^2 và chiều cao 5 cm.</div>
                    {% else %}
                        <!-- Mặc định hiển thị bài toán lớp 4 nếu không có lớp được chọn -->
                        <div class="problem-item" onclick="selectProblem('Tính diện tích hình chữ nhật có chiều dài 10 cm và chiều rộng 6 cm.')">Tính diện tích hình chữ nhật có chiều dài 10 cm và chiều rộng 6 cm.</div>
                        <div class="problem-item" onclick="selectProblem('Cộng hai phân số 3/7 và 2/7.')">Cộng hai phân số 3/7 và 2/7.</div>
                        <div class="problem-item" onclick="selectProblem('Chia 24 viên kẹo cho hai bạn An và Bình theo tỉ số 3:5. Hỏi mỗi bạn được bao nhiêu viên kẹo?')">Chia 24 viên kẹo cho hai bạn An và Bình theo tỉ số 3:5. Hỏi mỗi bạn được bao nhiêu viên kẹo?</div>
                        <div class="problem-item" onclick="selectProblem('Một ô tô đi với vận tốc 60 km/giờ trong 1,5 giờ. Hỏi ô tô đi được bao nhiêu km?')">Một ô tô đi với vận tốc 60 km/giờ trong 1,5 giờ. Hỏi ô tô đi được bao nhiêu km?</div>
                        <div class="problem-item" onclick="selectProblem('Lan có 40 quả táo, chia cho Minh và Hoa theo tỉ số 3:2. Hỏi mỗi bạn được bao nhiêu quả táo?')">Lan có 40 quả táo, chia cho Minh và Hoa theo tỉ số 3:2. Hỏi mỗi bạn được bao nhiêu quả táo?</div>
                    {% endif %}
                {% else %}
                    {% if session.get('grade', '4') == '1' %}
                        <!-- Tiếng Việt lớp 1 -->
                        <div class="problem-item" onclick="selectProblem('Đọc to đoạn văn sau: “Bé Na đi học về, vui vẻ kể chuyện cho mẹ nghe.”')">Đọc to đoạn văn sau: “Bé Na đi học về, vui vẻ kể chuyện cho mẹ nghe.”</div>
                        <div class="problem-item" onclick="selectProblem('Điền chữ cái còn thiếu: _ả, _ải, _ay, _an, _ang.')">Điền chữ cái còn thiếu: _ả, _ải, _ay, _an, _ang.</div>
                        <div class="problem-item" onclick="selectProblem('Tìm các từ có vần “an”.')">Tìm các từ có vần “an”.</div>
                        <div class="problem-item" onclick="selectProblem('Đặt câu với từ “bạn”.')">Đặt câu với từ “bạn”.</div>
                        <div class="problem-item" onclick="selectProblem('Khoanh tròn vào tiếng có âm “ch”: chim, cá, chó, mèo.')">Khoanh tròn vào tiếng có âm “ch”: chim, cá, chó, mèo.</div>
                    {% elif session.get('grade', '4') == '2' %}
                        <!-- Tiếng Việt lớp 2 -->
                        <div class="problem-item" onclick="selectProblem('Đọc đoạn văn và trả lời: “Nam thích giúp đỡ bạn bè. Em hãy kể một việc làm tốt của Nam.”')">Đọc đoạn văn và trả lời: “Nam thích giúp đỡ bạn bè. Em hãy kể một việc làm tốt của Nam.”</div>
                        <div class="problem-item" onclick="selectProblem('Điền vào chỗ trống: “Con ... đang bay trên bầu trời.”')">Điền vào chỗ trống: “Con ... đang bay trên bầu trời.”</div>
                        <div class="problem-item" onclick="selectProblem('Tìm từ trái nghĩa với “cao”.')">Tìm từ trái nghĩa với “cao”.</div>
                        <div class="problem-item" onclick="selectProblem('Đặt câu hỏi cho câu: “Lan đang học bài.”')">Đặt câu hỏi cho câu: “Lan đang học bài.”</div>
                        <div class="problem-item" onclick="selectProblem('Gạch chân dưới các từ chỉ hoạt động trong câu: “Bé chạy nhảy ngoài sân.”')">Gạch chân dưới các từ chỉ hoạt động trong câu: “Bé chạy nhảy ngoài sân.”</div>
                    {% elif session.get('grade', '4') == '3' %}
                        <!-- Tiếng Việt lớp 3 -->
                        <div class="problem-item" onclick="selectProblem('Đọc đoạn văn và trả lời câu hỏi: “Vì sao bạn nhỏ thích mùa hè?”')">Đọc đoạn văn và trả lời câu hỏi: “Vì sao bạn nhỏ thích mùa hè?”</div>
                        <div class="problem-item" onclick="selectProblem('Điền dấu chấm, dấu phẩy vào chỗ thích hợp.')">Điền dấu chấm, dấu phẩy vào chỗ thích hợp.</div>
                        <div class="problem-item" onclick="selectProblem('Tìm từ đồng nghĩa với “vui vẻ”.')">Tìm từ đồng nghĩa với “vui vẻ”.</div>
                        <div class="problem-item" onclick="selectProblem('Đặt câu với từ “học tập”.')">Đặt câu với từ “học tập”.</div>
                        <div class="problem-item" onclick="selectProblem('Phân biệt cách dùng “và” và “nhưng” trong câu.')">Phân biệt cách dùng “và” và “nhưng” trong câu.</div>
                    {% elif session.get('grade', '4') == '4' %}
                        <!-- Tiếng Việt lớp 4 -->
                        <div class="problem-item" onclick="selectProblem('Đọc thầm đoạn văn và cho biết ý chính.')">Đọc thầm đoạn văn và cho biết ý chính.</div>
                        <div class="problem-item" onclick="selectProblem('Tìm các từ ghép chỉ màu sắc.')">Tìm các từ ghép chỉ màu sắc.</div>
                        <div class="problem-item" onclick="selectProblem('Đặt 2 câu có sử dụng dấu hai chấm.')">Đặt 2 câu có sử dụng dấu hai chấm.</div>
                        <div class="problem-item" onclick="selectProblem('Viết đoạn văn ngắn tả một người bạn.')">Viết đoạn văn ngắn tả một người bạn.</div>
                        <div class="problem-item" onclick="selectProblem('Điền từ thích hợp vào chỗ trống: “Mẹ ... đi chợ mua rau.”')">Điền từ thích hợp vào chỗ trống: “Mẹ ... đi chợ mua rau.”</div>
                    {% elif session.get('grade', '4') == '5' %}
                        <!-- Tiếng Việt lớp 5 -->
                        <div class="problem-item" onclick="selectProblem('Đọc hiểu đoạn thơ và trả lời câu hỏi.')">Đọc hiểu đoạn thơ và trả lời câu hỏi.</div>
                        <div class="problem-item" onclick="selectProblem('Tìm 3 từ láy miêu tả tiếng cười.')">Tìm 3 từ láy miêu tả tiếng cười.</div>
                        <div class="problem-item" onclick="selectProblem('Đặt câu ghép có sử dụng liên từ “vì... nên”.')">Đặt câu ghép có sử dụng liên từ “vì... nên”.</div>
                        <div class="problem-item" onclick="selectProblem('Viết đoạn văn kể về một kỷ niệm đáng nhớ.')">Viết đoạn văn kể về một kỷ niệm đáng nhớ.</div>
                        <div class="problem-item" onclick="selectProblem('Phân tích cấu tạo của câu: “Bầu trời hôm nay thật đẹp.”')">Phân tích cấu tạo của câu: “Bầu trời hôm nay thật đẹp.”</div>
                    {% elif session.get('grade', '4') == '6' %}
                        <!-- Văn lớp 6 -->
                        <div class="problem-item" onclick="selectProblem('Đọc hiểu đoạn thơ “Qua Đèo Ngang” và nêu nội dung chính.')">Đọc hiểu đoạn thơ “Qua Đèo Ngang” và nêu nội dung chính.</div>
                        <div class="problem-item" onclick="selectProblem('Tìm 2 biện pháp tu từ trong đoạn thơ sau và giải thích tác dụng.')">Tìm 2 biện pháp tu từ trong đoạn thơ sau và giải thích tác dụng.</div>
                        <div class="problem-item" onclick="selectProblem('Viết đoạn văn cảm nhận về nhân vật Dế Mèn trong “Dế Mèn phiêu lưu ký”.')">Viết đoạn văn cảm nhận về nhân vật Dế Mèn trong “Dế Mèn phiêu lưu ký”.</div>
                        <div class="problem-item" onclick="selectProblem('Phân tích ý nghĩa nhan đề “Bức tranh của em gái tôi”.')">Phân tích ý nghĩa nhan đề “Bức tranh của em gái tôi”.</div>
                        <div class="problem-item" onclick="selectProblem('Tóm tắt truyện ngắn “Sơn Tinh, Thủy Tinh” bằng 5 câu.')">Tóm tắt truyện ngắn “Sơn Tinh, Thủy Tinh” bằng 5 câu.</div>
                    {% elif session.get('grade', '4') == '7' %}
                        <!-- Văn lớp 7 -->
                        <div class="problem-item" onclick="selectProblem('Đọc hiểu đoạn trích “Sống chết mặc bay” và trả lời câu hỏi.')">Đọc hiểu đoạn trích “Sống chết mặc bay” và trả lời câu hỏi.</div>
                        <div class="problem-item" onclick="selectProblem('Tìm 3 phép tu từ trong đoạn văn và nêu tác dụng.')">Tìm 3 phép tu từ trong đoạn văn và nêu tác dụng.</div>
                        <div class="problem-item" onclick="selectProblem('Viết đoạn văn nghị luận về tình bạn.')">Viết đoạn văn nghị luận về tình bạn.</div>
                        <div class="problem-item" onclick="selectProblem('Phân tích hình ảnh người mẹ trong bài thơ “Tiếng gà trưa”.')">Phân tích hình ảnh người mẹ trong bài thơ “Tiếng gà trưa”.</div>
                        <div class="problem-item" onclick="selectProblem('Viết đoạn văn kể về một trải nghiệm đáng nhớ ở trường.')">Viết đoạn văn kể về một trải nghiệm đáng nhớ ở trường.</div>
                    {% else %}
                        <!-- Mặc định hiển thị bài Tiếng Việt lớp 4 nếu không có lớp được chọn -->
                        <div class="problem-item" onclick="selectProblem('Đọc thầm đoạn văn và cho biết ý chính.')">Đọc thầm đoạn văn và cho biết ý chính.</div>
                        <div class="problem-item" onclick="selectProblem('Tìm các từ ghép chỉ màu sắc.')">Tìm các từ ghép chỉ màu sắc.</div>
                        <div class="problem-item" onclick="selectProblem('Đặt 2 câu có sử dụng dấu hai chấm.')">Đặt 2 câu có sử dụng dấu hai chấm.</div>
                        <div class="problem-item" onclick="selectProblem('Viết đoạn văn ngắn tả một người bạn.')">Viết đoạn văn ngắn tả một người bạn.</div>
                        <div class="problem-item" onclick="selectProblem('Điền từ thích hợp vào chỗ trống: “Mẹ ... đi chợ mua rau.”')">Điền từ thích hợp vào chỗ trống: “Mẹ ... đi chợ mua rau.”</div>
                    {% endif %}
                {% endif %}
            </div>
        </div>

        <!-- Cột bài toán gần đây (20%) -->
        <div class="recent-column">
            <h3>Bài toán gần đây ⏳</h3>
            {% if recent_questions %}
                <div class="recent-problems">
                    {% for question in recent_questions %}
                        <div class="recent-item" onclick="selectProblem('{{ question | e }}')">
                            {{ question }}
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p>Chưa có bài toán nào được hỏi gần đây.</p>
            {% endif %}
        </div>
    </div>

    <!-- Ô input box ở dưới cùng -->
    <div class="input-section">
        <form method="POST" id="main-form" enctype="multipart/form-data">
            <input type="hidden" name="subject" id="hidden-subject-input" value="{{ session.get('subject', 'math') }}">
            <div class="input-container">
                <textarea name="question" id="question-input" placeholder="Nhập câu hỏi (ví dụ: Câu 4)"></textarea>
                <button type="submit" name="action" value="ask" class="ask-btn">
                    <span>❓</span> Hỏi
                </button>
                <label class="upload-btn">
                    <span>📎</span> Đính kèm ảnh
                    <input type="file" name="file" id="file-input" class="file-input" accept="image/png,image/jpeg,image/jpg">
                </label>
            </div>
        </form>
    </div>

    <!-- Modal pop-up cho mẹo -->
    <div id="parentTipModal" class="modal">
        <div class="modal-content">
            <h4>Mẹo cho cha mẹ</h4>
            <p id="parentTipText">Đang tải mẹo...</p>
            <button class="close-btn" onclick="closeParentTip()">Đóng</button>
        </div>
    </div>

    <script>
        // Add a flag to prevent duplicate requests
        let isProcessingRequest = false;
        // Track extraction related errors
        let extractionErrorCount = 0;
        // Flag to differentiate between extraction and regular math problems
        let isExtractionMode = false;
        let pendingHintFetch = false;

        function makeProblemsClickable() {
            console.log("Making problem list items clickable...");
            const hintElements = document.querySelectorAll('.hint-text');
            hintElements.forEach(element => {
                let text = element.innerHTML;
                if (text.includes("Tớ thấy các bài toán:")) {
                    console.log("Found problem list in hint text, processing...");
                    const regex = /(Tớ thấy các bài toán:)(.*?)(\. Bạn muốn hỏi về bài nào\?)/;
                    const match = text.match(regex);
                    if (match) {
                        const problemsPart = match[2].trim();
                        const problems = problemsPart.split(',').map(p => p.trim());
                        let newHtml = match[1];
                        problems.forEach((problem, index) => {
                            newHtml += ` <span class="problem-link" onclick="selectProblemFromList('${problem}')" style="color: #1E88E5; text-decoration: underline; cursor: pointer;">${problem}</span>`;
                            if (index < problems.length - 1) newHtml += ',';
                        });
                        newHtml += match[3];
                        element.innerHTML = newHtml;
                        console.log("Updated hint text with clickable problems");
                    }
                }
            });

            const problemListContainers = document.querySelectorAll('.problem-list-container');
            problemListContainers.forEach(container => {
                let text = container.innerHTML;
                if (text.includes("Tớ thấy các bài toán:")) {
                    console.log("Found problem list in container, processing...");
                    const regex = /(Tớ thấy các bài toán:)(.*?)(\. Bạn muốn hỏi về bài nào\?)/;
                    const match = text.match(regex);
                    if (match) {
                        const problemsPart = match[2].trim();
                        const problems = problemsPart.split(',').map(p => p.trim());
                        let newHtml = match[1];
                        problems.forEach((problem, index) => {
                            newHtml += ` <span class="problem-link" onclick="selectProblemFromList('${problem}')" style="color: #1E88E5; text-decoration: underline; cursor: pointer;">${problem}</span>`;
                            if (index < problems.length - 1) newHtml += ',';
                        });
                        newHtml += match[3];
                        container.innerHTML = newHtml;
                        console.log("Updated problem list container with clickable problems");
                    }
                }
            });
        }

        function submitForm(action, additionalData = {}) {
            if (isProcessingRequest) {
                console.log("Request already in progress, ignoring...");
                return false;
            }
            
            isProcessingRequest = true;
            console.log(`Submitting form with action=${action}`);
            
            // Set extraction mode flag
            isExtractionMode = (action === 'extract_content' || action === 'check_extraction');
            
            // Show loading state in content section
            const contentSection = document.querySelector('.content-section');
            if (contentSection) {
                contentSection.innerHTML = `
                    <div class="loading-container">
                        <div class="loading-bar"></div>
                        <p class="loading-text">Đang xử lý yêu cầu...</p>
                    </div>
                `;
            }
            
            const form = document.getElementById('main-form');
            
            // Clear any previous action inputs
            form.querySelectorAll('input[type="hidden"]').forEach(el => {
                if (el.name === 'action' || el.name === 'clear_file' || 
                    el.name === 'direct_question' || el.name === 'skip_image_processing') {
                    el.remove();
                }
            });
            
            // Add the action input
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'action';
            hiddenInput.value = action;
            form.appendChild(hiddenInput);
            
            // Add skip_image_processing flag to prevent reprocessing images
            const skipProcessingInput = document.createElement('input');
            skipProcessingInput.type = 'hidden';
            skipProcessingInput.name = 'skip_image_processing';
            skipProcessingInput.value = 'true';
            form.appendChild(skipProcessingInput);
            
            // Add any additional data
            for (const [key, value] of Object.entries(additionalData)) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = value;
                form.appendChild(input);
            }
            
            // Set flag to fetch hints if this is an ask action
            if (action === 'ask') {
                pendingHintFetch = true;
            }
            
            // Use the form's action URL, not the form itself
            const formAction = form.getAttribute('action') || '/kids';
            
            // Create a timeout for long-running requests
            let requestTimeout = setTimeout(() => {
                if (isProcessingRequest && !isExtractionMode) {
                    // Only show timeout error for non-extraction requests
                    console.error("Request timed out");
                    showError("Yêu cầu đã quá thời gian chờ. Có thể có vấn đề với server hoặc kết nối mạng.");
                }
            }, 30000); // 30 seconds timeout
            
            // Use fetch instead of form submission to have more control
            const formData = new FormData(form);
            
            fetch(formAction, {
                method: 'POST',
                body: formData,
                cache: 'no-store'
            })
            .then(response => {
                clearTimeout(requestTimeout);
                if (!response.ok) {
                    throw new Error('Server responded with status: ' + response.status);
                }
                return response.text();
            })
            .then(html => {
                console.log("Form submitted successfully");
                
                // Don't process HTML response for extraction-related actions
                if (isExtractionMode) {
                    console.log("Skipping HTML processing for extraction action");
                    if (action !== 'check_extraction') {
                        isProcessingRequest = false;
                    }
                    return;
                }
                
                // First check if there are extracted problems to display
                if (action === 'attach_complete' && handleExtractedProblems(html)) {
                    console.log("Displayed extracted problems, skipping further processing");
                    return;
                }
                
                // Create a temporary container to parse the HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Find the content section in the response
                const newContentSection = tempDiv.querySelector('.content-section');
                const newChatColumn = tempDiv.querySelector('.chat-column');
                
                // Check for loading state in the response
                const isStillLoading = tempDiv.querySelector('#app-config')?.getAttribute('data-loading') === 'true';
                console.log("Server side loading state:", isStillLoading);
                
                if (!isStillLoading && newContentSection && contentSection) {
                    // Update content section
                    contentSection.innerHTML = newContentSection.innerHTML;
                }
                
                if (!isStillLoading && newChatColumn) {
                    const chatColumn = document.querySelector('.chat-column');
                    if (chatColumn) {
                        // Update chat column
                        chatColumn.innerHTML = newChatColumn.innerHTML;
                        // Scroll to bottom
                        chatColumn.scrollTop = chatColumn.scrollHeight;
                    }
                }
                
                // Always clear the processing state if we're not still loading
                if (!isStillLoading) {
                    isProcessingRequest = false;
                }
                
                // If this was an ask action, fetch hints immediately
                if (pendingHintFetch) {
                    pendingHintFetch = false;
                    console.log("Question submitted, now fetching hints...");
                    setTimeout(() => fetchHints(), 100);
                }
                
                // If we're still loading but the action was attach_complete, try again after a delay
                if (isStillLoading && action === 'attach_complete') {
                    console.log("Still loading, retrying after 3 seconds...");
                    setTimeout(() => {
                        // Try to directly parse whatever we can from the current response
                        if (handleExtractedProblems(html)) {
                            console.log("Found problems on retry, displaying them");
                            return;
                        }
                        console.log("Retrying attach_complete...");
                        submitForm('attach_complete');
                    }, 3000);
                }
            })
            .catch(error => {
                clearTimeout(requestTimeout);
                console.error('Error submitting form:', error);
                showError(`Có lỗi xảy ra khi xử lý yêu cầu: ${error.message}`);
            });
            
            return false; // Prevent traditional form submission
        }

        function selectProblem(problem) {
            try {
                console.log("Selecting problem:", problem);
                const input = document.getElementById('question-input');
                input.value = problem;
                
                resetProcessingState();
                return submitForm('ask', {
                    'direct_question': problem
                });
            } catch (error) {
                console.error('Error selecting problem:', error);
                alert('Có lỗi xảy ra khi chọn bài toán. Bạn thử lại nhé!');
                isProcessingRequest = false;
                return false;
            }
        }

        function fetchHints() {
            console.log("Fetching hints...");
            resetProcessingState();
            return submitForm('fetch_hints');
        }

        function completeAttach() {
            console.log("Starting completeAttach...");
            // Add a longer timeout for completeAttach
            setTimeout(() => {
                if (isProcessingRequest) {
                    console.log("Setting a 10 second timeout for completeAttach");
                    showFileProcessingUpdate("Đang xử lý file...");
                    setTimeout(() => {
                        if (isProcessingRequest) {
                            console.log("File processing taking longer than expected");
                            showFileProcessingUpdate("Việc xử lý file đang mất nhiều thởi gian hơn dự kiến...");
                        }
                    }, 10000);
                }
            }, 3000);
            
            return submitForm('attach_complete');
        }
        
        function showFileProcessingUpdate(message) {
            const contentSection = document.querySelector('.content-section');
            if (contentSection) {
                contentSection.innerHTML = `
                    <div class="loading-container">
                        <div class="loading-bar"></div>
                        <p class="loading-text">${message}</p>
                    </div>
                `;
            }
        }
        
        function handleExtractedProblems(html) {
            console.log("Checking for extracted problems in response");
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            // First, check if there's any hint containing "Tớ thấy các bài toán"
            const hints = tempDiv.querySelectorAll('.hint-text');
            if (hints.length > 0) {
                console.log("Found hints:", hints.length);
                for (const hint of hints) {
                    console.log("Hint content:", hint.textContent);
                    if (hint.textContent.includes("Tớ thấy các bài toán") || 
                        hint.textContent.includes("Bài 1") || 
                        hint.textContent.includes("Câu 1")) {
                        console.log("Found extracted problems in hint!");
                        
                        // Update the UI directly
                        const contentSection = document.querySelector('.content-section');
                        if (contentSection) {
                            contentSection.innerHTML = `
                                <p class="hint-text">${hint.textContent}</p>
                            `;
                        }
                        
                        // Clear loading state
                        isProcessingRequest = false;
                        return true;
                    }
                }
            }
            
            // Then check for problem list container
            const problemListContainer = tempDiv.querySelector('.problem-list-container');
            if (problemListContainer) {
                console.log("Found problem list container:", problemListContainer.textContent);
                // Extract the list of problems
                const problemText = problemListContainer.textContent;
                if (problemText.includes("Tớ thấy các bài toán") || 
                    problemText.includes("Bài 1") || 
                    problemText.includes("Câu 1")) {
                    console.log("Found problem list text");
                    
                    // Update the UI with the problem list
                    const contentSection = document.querySelector('.content-section');
                    if (contentSection) {
                        contentSection.innerHTML = `
                            <div class="problem-list-container">
                                ${problemText}
                            </div>
                        `;
                    }
                    
                    // Clear loading state
                    isProcessingRequest = false;
                    return true;
                }
            }
            
            // As a final fallback, check for any text that might contain the problems list
            const fullText = tempDiv.textContent;
            if (fullText.includes("Tớ thấy các bài toán") || 
                (fullText.includes("Bài 1") && fullText.includes("Bài 2")) || 
                (fullText.includes("Câu 1") && fullText.includes("Câu 2"))) {
                console.log("Found problems in full text");
                
                // Extract the relevant portion with regex
                const regex = /(Tớ thấy các bài toán[^\.]+)/;
                const match = regex.exec(fullText);
                if (match) {
                    const problemsText = match[1];
                    console.log("Extracted problems text:", problemsText);
                    
                    // Update the UI
                    const contentSection = document.querySelector('.content-section');
                    if (contentSection) {
                        contentSection.innerHTML = `
                            <p class="hint-text">${problemsText}</p>
                        `;
                    }
                    
                    // Clear loading state
                    isProcessingRequest = false;
                    return true;
                }
            }
            
            return false;
        }

        function showParentTip() {
            console.log("Showing parent tip...");
            const modal = document.getElementById('parentTipModal');
            const tipText = document.getElementById('parentTipText');
            tipText.textContent = 'Đang tải mẹo...';
            modal.style.display = 'flex';

            fetch('/get_parent_tip', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                tipText.textContent = data.tip;
                console.log("Parent tip loaded:", data.tip);
            })
            .catch(error => {
                console.error('Error fetching parent tip:', error);
                tipText.textContent = 'Có lỗi xảy ra khi lấy mẹo. Bạn thử lại nhé!';
            });
        }

        function closeParentTip() {
            console.log("Closing parent tip modal...");
            const modal = document.getElementById('parentTipModal');
            modal.style.display = 'none';
        }

        function showError(message) {
            console.error("Error:", message);
            const contentSection = document.querySelector('.content-section');
            if (contentSection) {
                contentSection.innerHTML = `
                    <p class="hint-text" style="color: #e53935;">${message}</p>
                    <p>Bạn có thể:</p>
                    <ul>
                        <li>Thử tải lại trang</li>
                        <li>Thử tải lên file khác</li>
                        <li>Nhập câu hỏi trực tiếp vào ô nhập</li>
                    </ul>
                `;
            }
            isProcessingRequest = false;
        }

        window.onclick = function(event) {
            const modal = document.getElementById('parentTipModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM fully loaded.");
            makeProblemsClickable();
            
            // Handle Jinja variables safely
            const configElement = document.getElementById('app-config');
            if (configElement) {
                const loading = configElement.getAttribute('data-loading') === 'true';
                const hint = configElement.getAttribute('data-hint');
                const loadingMessage = configElement.getAttribute('data-loading-message');
                
                // Clear input field if we have a response
                if (!loading && hint && hint !== "Nhập bài toán, bài tập Tiếng Việt hoặc tải ảnh đề bài để nhận gợi ý nhé! Đừng ngại hỏi bất cứ điều gì, tớ luôn sẵn sàng giúp bạn! 😊" && hint !== "File đã được tải lên thành công. Đang tự động trích xuất nội dung...") {
                    console.log("Clearing input field...");
                    const input = document.getElementById('question-input');
                    if (input) {
                        input.value = '';
                        input.placeholder = 'Nhập câu hỏi...';
                    }
                }
                
                // Handle loading state without using Jinja syntax in JavaScript
                if (loading && !isProcessingRequest) {
                    if (loadingMessage === "Đang tải và trích xuất nội dung file...") {
                        console.log("Detected file upload, calling completeAttach...");
                        setTimeout(completeAttach, 2000);
                    } else {
                        console.log("Detected loading state, fetching hints...");
                        setTimeout(fetchHints, 1000);
                    }
                }
            }

            console.log("Scrolling chat column to bottom...");
            const chatColumn = document.querySelector('.chat-column');
            if (chatColumn) {
                chatColumn.scrollTop = chatColumn.scrollHeight;
            }

            const fileInput = document.getElementById('file-input');
            if (fileInput) {
                fileInput.addEventListener('change', function() {
                    if (fileInput.files.length > 0 && !isProcessingRequest) {
                        console.log("File selected, submitting form...");
                        resetProcessingState();
                        submitForm('attach_file');
                    }
                });
            }
        });
        
        function resetProcessingState() {
            console.log("Resetting processing state");
            isProcessingRequest = false;
            isExtractionMode = false;
            pendingHintFetch = false;
            extractionErrorCount = 0;
        }
        
        function startExtraction() {
            console.log("Starting extraction process...");
            resetProcessingState();
            submitForm('extract_content');
            
            // Start polling for extraction status after a short delay
            setTimeout(() => {
                pollExtractionStatus();
            }, 1000);
        }
        
        function pollExtractionStatus() {
            console.log("Polling extraction status...");
            if (!isProcessingRequest || !isExtractionMode) {
                console.log("No extraction in progress or not in extraction mode, stopping poll");
                return;
            }
            
            // Make AJAX request to check status
            fetch('/kids', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'action=check_extraction',
                cache: 'no-store'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log("Extraction status:", data);
                
                if (data.status === 'completed') {
                    // Update UI with the result
                    const contentSection = document.querySelector('.content-section');
                    if (contentSection) {
                        // Check if the result contains problem list
                        if (data.result.includes("Tớ thấy các bài toán")) {
                            contentSection.innerHTML = `
                                <div class="problem-list-container">
                                    ${data.result}
                                </div>
                            `;
                        } else {
                            contentSection.innerHTML = `
                                <p class="hint-text">${data.result}</p>
                            `;
                        }
                    }
                    
                    // Clear processing state
                    isProcessingRequest = false;
                    console.log("Extraction completed");
                } else if (data.status === 'error') {
                    // Show error message
                    showError(data.message || "Có lỗi xảy ra khi trích xuất nội dung");
                    console.error("Extraction error:", data.message);
                } else {
                    // Still processing, poll again after delay
                    console.log("Extraction still in progress, polling again in 2 seconds...");
                    setTimeout(pollExtractionStatus, 2000);
                    
                    // Update loading message
                    const loadingText = document.querySelector('.loading-text');
                    if (loadingText) {
                        loadingText.textContent = "Đang trích xuất nội dung... Quá trình này có thể mất từ 10-20 giây";
                    }
                }
            })
            .catch(error => {
                console.error("Error checking extraction status:", error);
                // If error, still try again a few times
                extractionErrorCount = (extractionErrorCount || 0) + 1;
                if (extractionErrorCount < 3) {
                    setTimeout(pollExtractionStatus, 3000);
                } else {
                    showError("Không thể kết nối với server để kiểm tra trạng thái. Bạn thử tải lại trang.");
                    isProcessingRequest = false;
                }
            });
        }

        function selectProblemFromList(problem) {
            try {
                console.log("Selecting problem from list:", problem);
                const input = document.getElementById('question-input');
                input.value = problem;
                
                resetProcessingState();
                return submitForm('ask', {
                    'direct_question': problem,
                    'clear_extracted_problems': 'true'
                });
            } catch (error) {
                console.error('Error selecting problem from list:', error);
                alert('Có lỗi xảy ra khi chọn bài toán. Bạn thử lại nhé!');
                isProcessingRequest = false;
                return false;
            }
        }

        function onSubjectChange() {
            console.log("Subject changed, submitting form...");
            document.getElementById('subject-form').submit();
        }
    </script>
    <script src="{{ url_for('static', filename='js/kids.js') }}"></script>
</body>
</html>